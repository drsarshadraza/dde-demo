<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phytomedix | Clinical Twin Engine</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1b5e20;
      --secondary: #4caf50;
      --bg: #f4f7f6;
      --surface: #ffffff;
      --text: #2c3e50;
      --accent: #e8f5e9;
      --error: #e57373;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 600px;
      margin: 40px 20px;
    }

    /* HEADER */
    .header { text-align: center; margin-bottom: 20px; }
    .logo { color: var(--primary); font-size: 24px; font-weight: 900; letter-spacing: -0.5px; margin: 0; }
    .badge { 
      background: var(--accent); color: var(--primary); 
      font-size: 10px; font-weight: 700; 
      padding: 4px 8px; border-radius: 4px; 
      text-transform: uppercase; letter-spacing: 1px;
    }

    /* CARD UI */
    .card {
      background: var(--surface);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
      min-height: 400px;
    }

    /* WIZARD STEPS */
    .step { display: none; animation: slideIn 0.4s ease-out; }
    .step.active { display: block; }
    
    @keyframes slideIn { 
      from { opacity: 0; transform: translateX(10px); } 
      to { opacity: 1; transform: translateX(0); } 
    }

    /* PROGRESS BAR */
    .progress-container {
      height: 4px; background: #eee; border-radius: 2px; margin-bottom: 25px;
    }
    .progress-bar {
      height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; border-radius: 2px;
    }

    /* QUESTIONS */
    .q-label {
      display: block; font-size: 20px; font-weight: 700; margin-bottom: 10px; color: var(--text);
    }
    .q-sub {
      display: block; font-size: 14px; color: #666; margin-bottom: 25px; line-height: 1.5;
    }

    /* INPUTS */
    input[type="text"], input[type="email"], input[type="number"], select {
      width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 8px;
      font-size: 16px; box-sizing: border-box; transition: 0.2s; background: #fff;
    }
    input:focus, select:focus { border-color: var(--secondary); outline: none; }

    /* OPTIONS GRID */
    .options-grid { display: grid; gap: 12px; }
    .option-card {
      display: flex; align-items: center; padding: 14px;
      border: 2px solid #eee; border-radius: 10px; cursor: pointer; transition: 0.2s;
    }
    .option-card:hover { border-color: #ccc; background: #fafafa; }
    .option-card:has(input:checked) {
      border-color: var(--primary); background-color: var(--accent); color: var(--primary); font-weight: 600;
    }
    input[type="radio"], input[type="checkbox"] { margin-right: 12px; transform: scale(1.2); accent-color: var(--primary); }

    /* BUTTONS */
    .btn-group { display: flex; justify-content: space-between; margin-top: 40px; }
    .btn {
      padding: 14px 28px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 15px; transition: 0.2s;
    }
    .btn-next { background: var(--primary); color: white; flex: 1; margin-left: 10px; }
    .btn-next:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(27,94,32,0.2); }
    .btn-back { background: #f0f0f0; color: #666; }
    .btn:disabled { background: #e0e0e0; cursor: not-allowed; transform: none; }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.95); display: none;
      justify-content: center; align-items: center; z-index: 10;
      flex-direction: column; text-align: center;
    }
    .spinner { font-size: 50px; animation: spin 1s infinite linear; margin-bottom: 20px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .loading-text { font-weight: 600; color: var(--text); font-size: 18px; }
    .loading-sub { font-size: 13px; color: #666; margin-top: 5px; }

    /* RESULTS DASHBOARD */
    .result-view { display: none; }
    .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 15px; font-weight: 700; }
    
    /* RADAR CHART CONTAINER */
    .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 40px; }

    /* PRESCRIPTION STACK */
    .stack-container { margin-bottom: 30px; }
    .stack-header { 
      display: flex; align-items: center; background: #fafafa; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px;
    }
    .stack-icon { font-size: 20px; margin-right: 10px; }
    .stack-title { font-weight: 700; color: var(--text); }
    
    .product-card {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 0; border-bottom: 1px solid #eee;
    }
    .product-info strong { color: var(--primary); display: block; margin-bottom: 4px; }
    .product-info span { font-size: 12px; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; }
    .product-price { font-weight: 700; color: var(--text); text-align: right; }
    .product-price small { display: block; font-size: 10px; color: #999; font-weight: 400; }

    .total-bar {
      background: var(--text); color: white; padding: 20px; border-radius: 12px;
      display: flex; justify-content: space-between; align-items: center; margin-top: 30px;
    }
    .checkout-btn {
      background: var(--secondary); color: white; border: none; padding: 10px 20px;
      border-radius: 6px; font-weight: 700; cursor: pointer;
    }

  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 class="logo">PHYTOMEDIX</h1>
    <span class="badge">Engine v15.0</span>
  </div>

  <div class="card">
    
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="clinical-form">
      
      <div class="step active">
        <label class="q-label">Let's build your Digital Twin.</label>
        <span class="q-sub">We need a few basics to calibrate the engine.</span>
        
        <div style="margin-bottom: 15px;">
          <input type="text" name="name" placeholder="First Name" required>
        </div>
        <div style="margin-bottom: 15px;">
          <input type="email" name="email" placeholder="Email Address" required>
        </div>
        <div style="display:flex; gap:10px;">
          <input type="number" name="Q-001" placeholder="Age" style="flex:1" required>
          <div style="flex:1; border:2px solid #eee; border-radius:8px; display:flex; align-items:center; padding-left:10px; background:#fff;">
            <select name="Q-002" style="border:none; width:100%; outline:none; background:transparent;" required>
              <option value="" disabled selected>Select Sex</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>
        </div>
      </div>

      <div class="step">
        <label class="q-label">Biometric Scan</label>
        <span class="q-sub">These numbers help us calculate metabolic load and dosage safety.</span>
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <input type="number" name="Q-021" placeholder="Weight (kg)">
          <input type="number" name="Q-022" placeholder="Height (cm)">
        </div>
        <input type="number" name="Q-020" placeholder="Fasting Glucose (mg/dL) - Optional">
        <p style="font-size:12px; color:#999; margin-top:10px;">*Leave glucose blank if unknown.</p>
      </div>

      <div class="step">
        <label class="q-label">System Diagnostics</label>
        <span class="q-sub">Select all conditions that apply to you.</span>
        
        <div class="options-grid">
          <label class="option-card"><input type="checkbox" name="Q-010" value="Diabetes Type 2"> Diabetes / High Blood Sugar</label>
          <label class="option-card"><input type="checkbox" name="Q-010" value="High Cholesterol"> High Cholesterol</label>
          <label class="option-card"><input type="checkbox" name="Q-010" value="Hypertension"> High Blood Pressure</label>
          <label class="option-card"><input type="checkbox" name="Q-010" value="Brain Fog / Focus Issues"> Brain Fog / Low Focus</label>
          <label class="option-card"><input type="checkbox" name="Q-010" value="Joint Pain / Arthritis"> Joint Pain / Stiffness</label>
          <label class="option-card"><input type="checkbox" name="Q-010" value="IBS (Irritable Bowel)"> Gut Issues (IBS/Bloating)</label>
          <label class="option-card"><input type="checkbox" name="Q-010" value="Low Libido (Men)"> Low Libido (Men)</label>
          <label class="option-card"><input type="checkbox" name="Q-010" value="Menopause Symptoms"> Menopause Symptoms (Women)</label>
        </div>
      </div>

      <div class="step">
        <label class="q-label">Targeted Assessment</label>
        <span class="q-sub">Refining the cognitive and physical model.</span>
        
        <p style="margin-bottom:10px; font-weight:600;">Daily Focus & Memory?</p>
        <div class="options-grid" style="margin-bottom:25px;">
          <label class="option-card"><input type="radio" name="Q-023" value="Low"> Low (Struggling)</label>
          <label class="option-card"><input type="radio" name="Q-023" value="Average"> Average</label>
          <label class="option-card"><input type="radio" name="Q-023" value="High"> High (Sharp)</label>
        </div>

        <p style="margin-bottom:10px; font-weight:600;">Joint Stiffness?</p>
        <div class="options-grid">
          <label class="option-card"><input type="radio" name="Q-024" value="Yes"> Yes, regularly</label>
          <label class="option-card"><input type="radio" name="Q-024" value="No"> No, rarely</label>
        </div>
      </div>

      <div class="step">
        <label class="q-label">Safety & Contraindications</label>
        <span class="q-sub">We cross-reference your answers against 166 safety rules.</span>
        
        <p style="margin-bottom:10px; font-weight:600;">Do you smoke?</p>
        <div class="options-grid" style="margin-bottom:25px;">
          <label class="option-card"><input type="radio" name="Q-003" value="Never"> Never</label>
          <label class="option-card"><input type="radio" name="Q-003" value="Former"> Former</label>
          <label class="option-card"><input type="radio" name="Q-003" value="Current"> Currently</label>
        </div>

        <p style="margin-bottom:10px; font-weight:600;">Shortness of breath on exertion?</p>
        <div class="options-grid">
          <label class="option-card"><input type="radio" name="Q-015" value="No"> No</label>
          <label class="option-card"><input type="radio" name="Q-015" value="Yes"> Yes (Clinical Flag)</label>
        </div>
      </div>

      <div class="btn-group">
        <button type="button" class="btn btn-back" id="prevBtn" onclick="nextPrev(-1)" disabled>Back</button>
        <button type="button" class="btn btn-next" id="nextBtn" onclick="nextPrev(1)">Next Step</button>
      </div>

    </form>

    <div class="loading-overlay" id="loader">
      <div class="spinner">üß¨</div>
      <div class="loading-text" id="loadingText">Calibrating Digital Twin...</div>
      <div class="loading-sub">Please wait while we access the clinical engine</div>
    </div>

    <div id="result-view" class="result-view">
      
      <div style="text-align:center; margin-bottom:30px;">
        <h2 style="color:var(--primary); margin:0;">Analysis Complete</h2>
        <p style="color:#666; margin-top:5px;">Your Biological Digital Twin is ready.</p>
      </div>

      <div class="section-title">SYSTEMIC HEALTH VISUALIZATION</div>
      <div class="chart-container">
        <canvas id="twinChart"></canvas>
      </div>

      <div class="stack-container">
        <div class="stack-header">
          <span class="stack-icon">‚òÄÔ∏è</span>
          <span class="stack-title">Morning Protocol (AM)</span>
        </div>
        <div id="am-stack-list">
          </div>
      </div>

      <div class="stack-container">
        <div class="stack-header">
          <span class="stack-icon">üåô</span>
          <span class="stack-title">Evening Restoration (PM)</span>
        </div>
        <div id="pm-stack-list">
          </div>
      </div>

      <div class="total-bar">
        <div>
          <div style="font-size:12px; opacity:0.8;">MONTHLY TOTAL</div>
          <div style="font-size:24px; font-weight:700;" id="total-price">$0.00</div>
        </div>
        <button class="checkout-btn" onclick="alert('Proceeding to Secure Checkout...')">Subscribe & Save</button>
      </div>

      <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:20px; background:none; border:1px solid #eee; color:#999; border-radius:8px; cursor:pointer;">Restart Assessment</button>

    </div>

  </div>
</div>

<script>
  // --- CONFIGURATION ---
  // PASTE YOUR DEPLOYED WEB APP URL HERE (Ending in /exec)
  const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbyhP5V0najpzFsTivvfo6fIwZh5W4Hmdq18JCCYXguzxs8PHm28kq1pjj84p5jj2TzsWg/exec';
  
  // WIZARD LOGIC
  let currentStep = 0;
  const steps = document.querySelectorAll(".step");
  showStep(currentStep);

  function showStep(n) {
    steps.forEach((s, index) => {
      s.classList.remove("active");
      if(index === n) s.classList.add("active");
    });
    
    document.getElementById("prevBtn").disabled = (n === 0);
    document.getElementById("nextBtn").innerHTML = (n === steps.length - 1) ? "Run Clinical Analysis" : "Next Step";
    
    const progress = ((n + 1) / steps.length) * 100;
    document.getElementById("progressBar").style.width = progress + "%";
  }

  function nextPrev(n) {
    if (n === 1 && !validateForm()) return false;
    currentStep += n;
    if (currentStep >= steps.length) {
      submitForm();
      return;
    }
    showStep(currentStep);
  }

  function validateForm() {
    const activeStep = steps[currentStep];
    const inputs = activeStep.querySelectorAll("input[required], select[required]");
    let valid = true;
    inputs.forEach(input => {
      if (!input.value) {
        input.style.borderColor = "var(--error)";
        valid = false;
      } else {
        input.style.borderColor = "#eee";
      }
    });
    return valid;
  }

  // SUBMISSION LOGIC
  async function submitForm() {
    // 1. THE "PROCESSING" EXPERIENCE
    const loader = document.getElementById("loader");
    const loadText = document.getElementById("loadingText");
    loader.style.display = "flex";
    
    const phrases = [
      "Calibrating Digital Twin...", 
      "Analyzing Metabolic Load...", 
      "Checking 166 Safety Rules...", 
      "Optimizing Dosing Strategy...",
      "Generating Prescription..."
    ];
    let pIndex = 0;
    const interval = setInterval(() => {
      if(pIndex < phrases.length) {
        loadText.innerText = phrases[pIndex];
        pIndex++;
      }
    }, 800);

    // Prepare Data
    const formData = new FormData(document.getElementById("clinical-form"));
    const data = Object.fromEntries(formData.entries());
    const checked = Array.from(document.querySelectorAll('input[name="Q-010"]:checked')).map(cb => cb.value);
    data['Q-010'] = checked.join('; ');

    try {
      // Send to Backend
      await fetch(ENDPOINT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(data)
      });

      // 2. RENDER DASHBOARD (Simulated Logic for Instant UI)
      // Note: Real API would return JSON here. We simulate for UX speed.
      setTimeout(() => {
        clearInterval(interval);
        loader.style.display = "none";
        document.getElementById("clinical-form").style.display = "none";
        document.querySelector(".btn-group").style.display = "none";
        document.querySelector(".progress-container").style.display = "none";
        document.getElementById("result-view").style.display = "block";
        
        renderDashboard(data);
      }, 4000); // 4s wait for perceived value

    } catch (err) {
      alert("Connection Error. Please check internet.");
      loader.style.display = "none";
    }
  }

  function renderDashboard(data) {
    // A. SCORING SIMULATION (Mirrors Backend Logic)
    let scores = { metabolic: 30, cardio: 30, cognitive: 10, joints: 10, gut: 10, hormonal: 10 };
    const diag = (data['Q-010'] || "").toLowerCase();
    
    if (diag.includes('diabetes') || diag.includes('weight')) scores.metabolic = 90;
    if (diag.includes('hypertension') || diag.includes('cholesterol')) scores.cardio = 80;
    if (diag.includes('brain') || data['Q-023'] === 'Low') scores.cognitive = 75;
    if (diag.includes('joint') || data['Q-024'] === 'Yes') scores.joints = 85;
    if (diag.includes('ibs') || diag.includes('bloating')) scores.gut = 70;
    if (diag.includes('libido') || diag.includes('menopause')) scores.hormonal = 65;

    // Render Radar Chart
    const ctx = document.getElementById('twinChart').getContext('2d');
    new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['Metabolic', 'Cardio', 'Cognitive', 'Joints', 'Gut', 'Hormonal'],
        datasets: [{
          label: 'Health Integrity Score',
          data: [scores.metabolic, scores.cardio, scores.cognitive, scores.joints, scores.gut, scores.hormonal],
          backgroundColor: 'rgba(27, 94, 32, 0.2)',
          borderColor: '#1b5e20',
          pointBackgroundColor: '#1b5e20',
          borderWidth: 2
        }]
      },
      options: {
        scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } },
        plugins: { legend: { display: false } }
      }
    });

    // B. PRESCRIPTION LOGIC (Commercial)
    let amItems = [];
    let pmItems = [];
    let total = 0;

    // Logic: Map High Scores to Mock Products (Matches your Catalog P-IDs)
    if (scores.metabolic > 60) {
      amItems.push({ name: "P125: Diabetes Blend", reason: "Glucose Stabilization", price: 49.00, type: "Core" });
      if (scores.metabolic > 80) amItems.push({ name: "Berberine HCL Booster", reason: "Insulin Sensitivity", price: 29.00, type: "Booster" });
    }
    if (scores.cardio > 60) {
      amItems.push({ name: "P113: Cardio Tonic Blend", reason: "Vascular Flow", price: 45.00, type: "Core" });
    }
    if (scores.cognitive > 60) {
      amItems.push({ name: "P118: Nootropic Nutrients", reason: "Dopamine Support", price: 39.00, type: "Core" });
    }
    if (scores.joints > 60) {
      pmItems.push({ name: "P153: Healthy Joints Blend", reason: "Inflammation Repair", price: 45.00, type: "Restorative" });
    }
    if (scores.gut > 60) {
      amItems.push({ name: "P130: IBS Blend", reason: "Microbiome Diversity", price: 35.00, type: "Probiotic" });
    }
    if (scores.hormonal > 50) {
      const sex = data['Q-002'];
      if(sex === 'Male') amItems.push({ name: "P109: Sterone Booster", reason: "Testosterone Optimization", price: 55.00, type: "Core" });
      else amItems.push({ name: "P138: Menopause Relief", reason: "Cycle Balance", price: 55.00, type: "Core" });
    }

    // Default Fallback
    if (amItems.length === 0 && pmItems.length === 0) {
      amItems.push({ name: "P146: Multivitamin Foundation", reason: "Baseline Optimization", price: 49.00, type: "Core" });
    }

    // Helper to render list
    const renderList = (items, containerId) => {
      const container = document.getElementById(containerId);
      if (items.length === 0) {
        container.innerHTML = "<div style='color:#999; font-size:13px; font-style:italic; padding:10px;'>No specific requirements for this phase.</div>";
        return;
      }
      let html = "";
      items.forEach(item => {
        total += item.price;
        html += `
          <div class="product-card">
            <div class="product-info">
              <strong>${item.name}</strong>
              <span>${item.reason}</span>
            </div>
            <div class="product-price">
              $${item.price.toFixed(2)}
              <small>${item.type}</small>
            </div>
          </div>`;
      });
      container.innerHTML = html;
    };

    renderList(amItems, 'am-stack-list');
    renderList(pmItems, 'pm-stack-list');
    
    document.getElementById('total-price').innerText = "$" + total.toFixed(2);
  }
</script>

</body>
</html>
