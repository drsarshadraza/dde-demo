<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phytomedix | Clinical Twin Engine</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* 1. CORE THEME: CLINICAL BUT PREMIUM */
    :root {
      --primary: #1b5e20; /* Deep Medical Green */
      --secondary: #4caf50; /* Action Green */
      --bg: #f4f7f6;
      --surface: #ffffff;
      --text: #2c3e50;
      --accent: #e8f5e9;
      --error: #e57373;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 650px;
      margin: 40px 20px;
    }

    /* HEADER */
    .header { text-align: center; margin-bottom: 25px; }
    .logo { color: var(--primary); font-size: 26px; font-weight: 900; letter-spacing: -0.5px; margin: 0; }
    .badge { 
      background: var(--accent); color: var(--primary); 
      font-size: 11px; font-weight: 700; 
      padding: 4px 8px; border-radius: 4px; 
      text-transform: uppercase; letter-spacing: 1px;
    }

    /* MAIN INTERFACE CARD */
    .card {
      background: var(--surface);
      border-radius: 16px;
      padding: 35px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
      min-height: 500px;
    }

    /* WIZARD ANIMATIONS */
    .step { display: none; animation: fadeIn 0.5s ease-out; }
    .step.active { display: block; }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* PROGRESS BAR */
    .progress-container {
      height: 6px; background: #eee; border-radius: 3px; margin-bottom: 30px;
    }
    .progress-bar {
      height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; border-radius: 3px;
    }

    /* TYPOGRAPHY */
    .q-label {
      display: block; font-size: 22px; font-weight: 700; margin-bottom: 10px; color: var(--text);
    }
    .q-sub {
      display: block; font-size: 15px; color: #666; margin-bottom: 25px; line-height: 1.5;
    }

    /* INPUTS */
    input[type="text"], input[type="email"], input[type="number"], select {
      width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px;
      font-size: 16px; box-sizing: border-box; transition: 0.2s; background: #fff;
    }
    input:focus, select:focus { border-color: var(--secondary); outline: none; }

    /* OPTIONS GRID */
    .options-grid { display: grid; gap: 12px; }
    .option-card {
      display: flex; align-items: center; padding: 14px;
      border: 2px solid #eee; border-radius: 10px; cursor: pointer; transition: 0.2s;
    }
    .option-card:hover { border-color: #ccc; background: #fafafa; }
    .option-card:has(input:checked) {
      border-color: var(--primary); background-color: var(--accent); color: var(--primary); font-weight: 600;
    }
    input[type="radio"], input[type="checkbox"] { margin-right: 15px; transform: scale(1.3); accent-color: var(--primary); }

    /* BUTTONS */
    .btn-group { display: flex; justify-content: space-between; margin-top: 40px; }
    .btn {
      padding: 14px 28px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 16px; transition: 0.2s;
    }
    .btn-next { background: var(--primary); color: white; flex: 1; margin-left: 15px; box-shadow: 0 4px 12px rgba(27,94,32,0.2); }
    .btn-next:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(27,94,32,0.3); }
    .btn-back { background: #f0f0f0; color: #666; }
    .btn:disabled { background: #e0e0e0; cursor: not-allowed; transform: none; box-shadow: none; }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.98); display: none;
      justify-content: center; align-items: center; z-index: 100;
      flex-direction: column; text-align: center;
    }
    .spinner { font-size: 60px; animation: pulse 1.5s infinite ease-in-out; margin-bottom: 20px; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
    .loading-text { font-weight: 700; color: var(--primary); font-size: 20px; margin-bottom: 5px; }
    .loading-sub { font-size: 14px; color: #666; }

    /* RESULTS DASHBOARD */
    .result-view { display: none; }
    .section-header { 
      font-size: 12px; text-transform: uppercase; letter-spacing: 2px; 
      color: #999; margin: 30px 0 15px 0; font-weight: 800; border-bottom: 2px solid #eee; padding-bottom: 5px; 
    }
    
    /* RADAR CHART CONTAINER */
    .chart-container { position: relative; height: 320px; width: 100%; margin-bottom: 20px; }

    /* PRESCRIPTION STACK */
    .stack-container { margin-bottom: 25px; }
    .stack-header { 
      display: flex; align-items: center; background: #f8f9fa; padding: 12px 15px; 
      border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--secondary);
    }
    .stack-icon { font-size: 22px; margin-right: 12px; }
    .stack-title { font-weight: 700; color: var(--text); font-size: 16px; }
    
    .product-card {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 0; border-bottom: 1px solid #eee; animation: fadeIn 0.5s ease;
    }
    .product-info strong { color: var(--primary); display: block; margin-bottom: 4px; font-size: 15px; }
    .product-info span { font-size: 13px; color: #555; display: block; }
    .product-badge { font-size: 10px; background: #e0f2f1; color: #00695c; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-top:4px; display:inline-block;}
    .product-price { font-weight: 800; color: var(--text); text-align: right; font-size: 16px; }

    .total-bar {
      background: var(--text); color: white; padding: 25px; border-radius: 12px;
      display: flex; justify-content: space-between; align-items: center; margin-top: 40px;
      box-shadow: 0 10px 25px rgba(44, 62, 80, 0.3);
    }
    .checkout-btn {
      background: var(--secondary); color: white; border: none; padding: 12px 25px;
      border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.2s;
    }
    .checkout-btn:hover { background: #43a047; transform: scale(1.02); }

  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 class="logo">PHYTOMEDIX</h1>
    <span class="badge">Engine v15.0</span>
  </div>

  <div class="card">
    
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="clinical-form">
      <div id="wizard-content"></div>
      
      <div class="btn-group">
        <button type="button" class="btn btn-back" id="prevBtn" onclick="nextPrev(-1)" disabled>Back</button>
        <button type="button" class="btn btn-next" id="nextBtn" onclick="nextPrev(1)">Next Step</button>
      </div>
    </form>
    <div class="loading-overlay" id="loader">
      <div class="spinner">üß¨</div>
      <div class="loading-text" id="loadingText">Calibrating Digital Twin...</div>
      <div class="loading-sub">Please wait while we access the clinical engine</div>
    </div>

    <div id="result-view" class="result-view">
      
      <div style="text-align:center; margin-bottom:30px;">
        <h2 style="color:var(--primary); margin:0;">Analysis Complete</h2>
        <p style="color:#666; margin-top:5px;">Here is your Digital Health Twin.</p>
      </div>

      <div class="section-header">SYSTEMIC HEALTH SCORE</div>
      <div class="chart-container">
        <canvas id="twinChart"></canvas>
      </div>

      <div class="section-header">YOUR PRESCRIPTION PROTOCOL</div>
      <div class="stack-container">
        <div class="stack-header">
          <span class="stack-icon">‚òÄÔ∏è</span>
          <span class="stack-title">Morning Fuel (AM)</span>
        </div>
        <div id="am-stack-list">
          </div>
      </div>

      <div class="stack-container">
        <div class="stack-header">
          <span class="stack-icon">üåô</span>
          <span class="stack-title">Evening Restoration (PM)</span>
        </div>
        <div id="pm-stack-list">
          </div>
      </div>

      <div class="total-bar">
        <div>
          <div style="font-size:12px; opacity:0.8;">MONTHLY SUBSCRIPTION</div>
          <div style="font-size:28px; font-weight:700;" id="total-price">$0.00</div>
        </div>
        <button class="checkout-btn" onclick="alert('Proceeding to Secure Checkout...')">Reserve My Stack</button>
      </div>

      <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:20px; background:none; border:1px solid #eee; color:#999; border-radius:8px; cursor:pointer;">Restart Assessment</button>

    </div>

  </div>
</div>

<script>
  // --- CONFIGURATION ---
  const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbyhP5V0najpzFsTivvfo6fIwZh5W4Hmdq18JCCYXguzxs8PHm28kq1pjj84p5jj2TzsWg/exec'; // REPLACE WITH YOUR URL
  
  // --- INTEGRATED DATA FROM CSV ---
  // This matches your Diagnostics QBank v5.0 exactly
  const QUESTIONS = [
    { "id": "name", "text": "Full Name", "type": "text" },
    { "id": "email", "text": "Email Address", "type": "email" },
    { "id": "Q-001", "text": "What is your age?", "type": "single_numeric" },
    { "id": "Q-002", "text": "What is your biological sex?", "type": "single_choice", "options": [ "Male", "Female" ] },
    { "id": "Q-003", "text": "Do you currently smoke cigarettes or use tobacco?", "type": "single_choice", "options": [ "Never", "Former", "Current" ] },
    { "id": "Q-004", "text": "How many cigarettes per day do you smoke?", "type": "single_numeric" },
    { "id": "Q-005", "text": "How often do you consume alcoholic beverages?", "type": "single_choice", "options": [ "Never", "Monthly", "Weekly", "Daily" ] },
    { "id": "Q-006", "text": "How many hours of sleep do you usually get per night?", "type": "single_numeric" },
    { "id": "Q-007", "text": "How would you rate your typical stress level?", "type": "single_choice", "options": [ "Low", "Moderate", "High" ] },
    { "id": "Q-008", "text": "How many minutes of moderate or vigorous activity do you do weekly?", "type": "single_numeric" },
    { "id": "Q-009", "text": "Has any parent or sibling been diagnosed with heart disease before age 55?", "type": "yes_no", "options": [ "Yes", "No" ] },
    { "id": "Q-010", "text": "Do you have any of the following health concerns or diagnoses?", "type": "multi_select", "options": [ "None", "Diabetes Type 2", "High Cholesterol", "Hypertension", "Obesity / Weight Management", "IBS (Irritable Bowel)", "Gastritis / Acid Reflux", "Bloating / Digestion Issues", "Liver Fatty / Inflammation", "Brain Fog / Focus Issues", "Anxiety / High Stress", "Insomnia / Sleep Issues", "Low Energy / Fatigue", "Memory Decline", "Joint Pain / Arthritis", "Muscle Weakness", "Skin Health / Aging", "Vision / Eye Health", "Low Immunity / Frequent Colds", "Low Libido (Men)", "Prostate Issues", "Erectile Dysfunction", "Male Fertility", "Menopause Symptoms", "PCOS / Hormonal Imbalance", "Low Libido (Women)", "Female Fertility" ], "subtext": "Select all that apply.", "layout": "double" },
    { "id": "Q-011", "text": "Have you ever used hormone replacement therapy (HRT)?", "type": "yes_no", "options": [ "Yes", "No" ] },
    { "id": "Q-012", "text": "Have you noticed erectile difficulties?", "type": "yes_no", "options": [ "Yes", "No" ] },
    { "id": "Q-013", "text": "Do you have any known food allergies or intolerances?", "type": "multi_select", "options": [ "Gluten", "Lactose", "Nuts", "Shellfish", "None" ], "subtext": "Select all that apply." },
    { "id": "Q-014", "text": "In the past year, have you unintentionally lost more than 5 kg?", "type": "yes_no", "options": [ "Yes", "No" ] },
    { "id": "Q-015", "text": "Do you often feel short of breath on mild exertion?", "type": "yes_no", "options": [ "Yes", "No" ] },
    { "id": "Q-016", "text": "Have you ever been told you have fatty liver disease?", "type": "yes_no", "options": [ "Yes", "No" ] },
    { "id": "Q-017", "text": "Do you have a family history of any of the following cancers?", "type": "multi_select", "options": [ "Breast", "Ovarian", "Colorectal", "Prostate", "None" ], "subtext": "Select all that apply." },
    { "id": "Q-018", "text": "Do you have known genetic results (e.g. BRCA, APOE)?", "type": "yes_no", "options": [ "Yes", "No" ] },
    { "id": "Q-019", "text": "Enter your most recent Systolic Blood Pressure (Top number) if known.", "type": "single_numeric" },
    { "id": "Q-020", "text": "Enter your most recent Fasting Glucose (mg/dL) if known.", "type": "single_numeric" },
    { "id": "Q-021", "text": "What is your current Weight (in kg)?", "type": "single_numeric" },
    { "id": "Q-022", "text": "What is your current Height (in cm)?", "type": "single_numeric" },
    { "id": "Q-023", "text": "How would you rate your daily focus and memory?", "type": "single_choice", "options": [ "Low", "Average", "High" ] },
    { "id": "Q-024", "text": "Do you experience joint stiffness or pain?", "type": "yes_no", "options": [ "Yes", "No" ] }
  ];

  // --- WIZARD RENDER LOGIC ---
  let currentStep = 0;
  let steps = [];

  document.addEventListener('DOMContentLoaded', () => {
    renderWizard();
  });

  function renderWizard() {
    const container = document.getElementById('wizard-content');
    
    // Group Questions into "Pages" for better UX
    const pages = [
      { title: "Identity", ids: ['name', 'email', 'Q-001', 'Q-002'] },
      { title: "Biometrics", ids: ['Q-021', 'Q-022', 'Q-019', 'Q-020'] },
      { title: "Lifestyle", ids: ['Q-003', 'Q-004', 'Q-005', 'Q-006', 'Q-007', 'Q-008'] },
      { title: "Clinical Symptoms", ids: ['Q-010', 'Q-023', 'Q-024'] },
      { title: "Medical History", ids: ['Q-009', 'Q-011', 'Q-012', 'Q-013', 'Q-014', 'Q-015', 'Q-016', 'Q-017', 'Q-018'] }
    ];

    pages.forEach((page, index) => {
      const stepDiv = document.createElement('div');
      stepDiv.className = `step ${index === 0 ? 'active' : ''}`;
      stepDiv.innerHTML = `<label class="q-label">${page.title}</label><span class="q-sub">Step ${index+1} of ${pages.length}</span>`;
      
      page.ids.forEach(qid => {
        const q = QUESTIONS.find(x => x.id === qid);
        if(!q) return;
        
        let html = `<div style="margin-bottom:20px;"><p style="font-weight:600; margin-bottom:8px;">${q.text}</p>`;
        
        if (q.type === 'text' || q.type === 'email') {
          html += `<input type="${q.type}" name="${q.id}" placeholder="Type here..." required>`;
        } 
        else if (q.type === 'single_numeric') {
          html += `<input type="number" name="${q.id}" placeholder="0" style="width:100%;">`;
        }
        else if (q.options) {
          const type = (q.type === 'multi_select') ? 'checkbox' : 'radio';
          html += `<div class="options-grid">`;
          q.options.forEach(opt => {
             // Clean ID for labels
             const cleanOpt = opt.replace(/[^a-zA-Z0-9]/g, '');
             const optId = `${q.id}-${cleanOpt}`;
             html += `<label class="option-card" for="${optId}">
                        <input type="${type}" id="${optId}" name="${q.id}" value="${opt}"> ${opt}
                      </label>`;
          });
          html += `</div>`;
        }
        html += `</div>`;
        stepDiv.innerHTML += html;
      });
      
      container.appendChild(stepDiv);
    });

    steps = document.querySelectorAll(".step");
    showStep(0);
  }

  function showStep(n) {
    steps.forEach((s, index) => {
      s.classList.remove("active");
      if(index === n) s.classList.add("active");
    });
    
    document.getElementById("prevBtn").disabled = (n === 0);
    document.getElementById("nextBtn").innerHTML = (n === steps.length - 1) ? "Run Analysis" : "Next Step";
    
    const progress = ((n + 1) / steps.length) * 100;
    document.getElementById("progressBar").style.width = progress + "%";
  }

  function nextPrev(n) {
    currentStep += n;
    if (currentStep >= steps.length) {
      submitForm();
      return;
    }
    showStep(currentStep);
  }

  // --- SUBMISSION ---
  async function submitForm() {
    const loader = document.getElementById("loader");
    loader.style.display = "flex";
    
    // Animate Loading Text
    const phrases = ["Calibrating Digital Twin...", "Analyzing Metabolic Load...", "Checking 166 Safety Rules...", "Generating Prescription..."];
    let pIndex = 0;
    const interval = setInterval(() => { if(pIndex < phrases.length) document.getElementById("loadingText").innerText = phrases[pIndex++]; }, 1000);

    // Collect Data
    const formData = new FormData(document.getElementById("clinical-form"));
    const data = Object.fromEntries(formData.entries());
    
    // Fix Multi-Selects (Q-010, Q-013, Q-017)
    ['Q-010', 'Q-013', 'Q-017'].forEach(key => {
        const checked = Array.from(document.querySelectorAll(`input[name="${key}"]:checked`)).map(cb => cb.value);
        data[key] = checked.join('; ');
    });

    try {
      await fetch(ENDPOINT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(data)
      });

      setTimeout(() => {
        clearInterval(interval);
        loader.style.display = "none";
        document.getElementById("clinical-form").style.display = "none";
        document.querySelector(".btn-group").style.display = "none";
        document.getElementById("result-view").style.display = "block";
        renderDashboard(data);
      }, 4000);

    } catch (err) {
      alert("Connection Error.");
      loader.style.display = "none";
    }
  }

  // --- DASHBOARD RENDERER ---
  function renderDashboard(data) {
    // 1. Scoring (Simulation for Instant UX)
    let scores = { metabolic: 20, cardio: 20, cognitive: 20, joints: 20, gut: 20, hormonal: 20 };
    const symptoms = (data['Q-010'] || "") + (data['Q-013'] || ""); // Concatenate symptom strings
    
    if(symptoms.includes('Diabetes') || data['Q-021'] > 100) scores.metabolic = 90;
    if(symptoms.includes('Joint') || data['Q-024'] === 'Yes') scores.joints = 85;
    if(symptoms.includes('Brain') || data['Q-023'] === 'Low') scores.cognitive = 80;
    if(symptoms.includes('IBS') || symptoms.includes('Bloating')) scores.gut = 75;
    if(symptoms.includes('Libido')) scores.hormonal = 70;

    // 2. Radar Chart
    new Chart(document.getElementById('twinChart'), {
      type: 'radar',
      data: {
        labels: ['Metabolic', 'Cardio', 'Cognitive', 'Joints', 'Gut', 'Hormonal'],
        datasets: [{
          label: 'Health Score',
          data: [scores.metabolic, scores.cardio, scores.cognitive, scores.joints, scores.gut, scores.hormonal],
          backgroundColor: 'rgba(27, 94, 32, 0.2)',
          borderColor: '#1b5e20',
          borderWidth: 2
        }]
      },
      options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
    });

    // 3. Products (Simulation based on Scores)
    let amList = [], pmList = [], total = 0;
    
    if(scores.metabolic > 60) amList.push({name: "P125: Diabetes Blend", price: 49, desc: "Glucose Control"});
    if(scores.joints > 60) pmList.push({name: "P153: Healthy Joints Blend", price: 45, desc: "Inflammation Repair"});
    if(scores.cognitive > 60) amList.push({name: "P118: Nootropic Nutrients", price: 39, desc: "Focus Support"});
    if(scores.gut > 60) amList.push({name: "P130: IBS Blend", price: 35, desc: "Microbiome Reset"});
    if(scores.hormonal > 60) amList.push({name: "P109: Sterone Booster", price: 55, desc: "Endocrine Support"});
    
    if(amList.length === 0 && pmList.length === 0) amList.push({name: "P146: Multivitamin Foundation", price: 49, desc: "Daily Essentials"});

    const printList = (list, divId) => {
        let h = "";
        list.forEach(i => {
            total += i.price;
            h += `<div class="product-card">
                    <div class="product-info"><strong>${i.name}</strong><span>${i.desc}</span></div>
                    <div class="product-price">$${i.price}</div>
                  </div>`;
        });
        document.getElementById(divId).innerHTML = h || "<div style='padding:10px; color:#999;'>No specific requirements.</div>";
    };

    printList(amList, 'am-stack-list');
    printList(pmList, 'pm-stack-list');
    document.getElementById('total-price').innerText = "$" + total.toFixed(2);
  }
</script>

</body>
</html>
