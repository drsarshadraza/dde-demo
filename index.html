<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phytomedix | Clinical Twin Engine</title>
  <style>
    :root {
      --primary: #1b5e20;
      --secondary: #4caf50;
      --bg: #f8f9fa;
      --surface: #ffffff;
      --text: #2c3e50;
      --border: #e0e0e0;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 650px;
      margin: 40px 20px;
    }

    /* HEADER */
    .header { text-align: center; margin-bottom: 30px; }
    .logo { color: var(--primary); font-size: 28px; font-weight: 900; letter-spacing: -1px; margin: 0; }
    .badge { 
      background: #e8f5e9; color: var(--primary); 
      font-size: 11px; font-weight: 700; 
      padding: 4px 8px; border-radius: 4px; 
      text-transform: uppercase; letter-spacing: 1px;
    }

    /* CARD */
    .card {
      background: var(--surface);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.05);
    }

    /* QUESTIONS */
    .question-group {
      margin-bottom: 30px;
      animation: fadeIn 0.4s ease-in-out;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .q-label {
      display: block;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text);
      line-height: 1.4;
    }

    /* INPUTS */
    input[type="text"], input[type="email"], input[type="number"] {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      transition: 0.2s;
      box-sizing: border-box; 
    }
    input:focus { border-color: var(--primary); outline: none; }

    /* OPTIONS GRID */
    .options-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .option-card {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: #fff;
    }
    .option-card:hover { border-color: #b0bec5; background: #fafafa; }
    
    /* SELECTED STATE */
    .option-card:has(input:checked) {
      border-color: var(--primary);
      background-color: #e8f5e9;
      color: var(--primary);
      font-weight: 600;
    }

    input[type="radio"], input[type="checkbox"] {
      margin-right: 12px;
      transform: scale(1.2);
      accent-color: var(--primary);
    }

    /* BUTTON */
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(27, 94, 32, 0.2);
      transition: 0.2s;
    }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(27, 94, 32, 0.3); }
    .submit-btn:disabled { background: #9e9e9e; cursor: not-allowed; transform: none; }

    /* SUCCESS STATE */
    .success-box {
      display: none; text-align: center; padding: 20px;
    }
    .icon-pulse { font-size: 50px; display: block; margin-bottom: 20px; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 class="logo">PHYTOMEDIX AI</h1>
    <span class="badge">Digital Twin v10.0</span>
  </div>

  <div class="card">
    
    <form id="clinical-form">
      <div id="form-content"></div> <button type="submit" class="submit-btn">Run Clinical Analysis</button>
    </form>

    <div id="success-view" class="success-box">
      <div class="icon-pulse">ðŸ§¬</div>
      <h2>Analysis Complete</h2>
      <p style="color:#666; margin-bottom: 30px;">Your biological data has been mapped to the Clinical Engine.</p>
      <button onclick="location.reload()" style="padding:10px 20px; cursor:pointer; background:none; border:1px solid #ccc; border-radius:4px;">Start New Session</button>
    </div>

  </div>
</div>

<script>
  // --- 1. CONFIGURATION ---
  // Connects to your Google Apps Script
  const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbx8Da6T9lg4NVdKXTbCFlPujJ7YcJA1ewxohoJEkjjBgKLaXg8i9ydwJ6sXS7jnA-w-4A/exec';

  // --- 2. EMBEDDED QUESTION BANK (No CSV Required) ---
  // This guarantees perfect text rendering every time.
  const QUESTIONS = [
    { id: 'name', text: 'Full Name', type: 'text' },
    { id: 'email', text: 'Email Address', type: 'email' },
    
    { id: 'Q-001', text: 'What is your age?', type: 'single_numeric' },
    { id: 'Q-002', text: 'What is your biological sex?', type: 'single_choice', options: ['Male', 'Female'] },
    
    // CARDIOVASCULAR
    { id: 'Q-003', text: 'Do you currently smoke cigarettes or use tobacco?', type: 'single_choice', options: ['Never', 'Former', 'Current'] },
    { id: 'Q-004', text: 'How many cigarettes per day do you smoke?', type: 'single_numeric', condition: { if: 'Q-003', equals: 'Current' } },
    
    { id: 'Q-019', text: 'Enter your last known Systolic BP (Top number)', type: 'single_numeric' },
    { id: 'Q-015', text: 'CRITICAL: Do you feel short of breath on mild exertion?', type: 'yes_no', options: ['Yes', 'No'] },
    { id: 'Q-009', text: 'Family History: Has a parent had a heart attack before age 55?', type: 'yes_no', options: ['Yes', 'No'] },

    // METABOLIC
    { id: 'Q-021', text: 'What is your current Weight (in kg)?', type: 'single_numeric' },
    { id: 'Q-022', text: 'What is your current Height (in cm)?', type: 'single_numeric' },
    { id: 'Q-010', text: 'Have you been diagnosed with any of the following?', type: 'multi_select', options: ['Hypertension', 'Diabetes Type 2', 'High Cholesterol', 'None'] },
    { id: 'Q-020', text: 'Fasting Glucose (mg/dL) - Leave blank if unknown', type: 'single_numeric' },
    
    // LIFESTYLE & ONCOLOGY
    { id: 'Q-005', text: 'How often do you consume alcoholic beverages?', type: 'single_choice', options: ['Never', 'Monthly', 'Weekly', 'Daily'] },
    { id: 'Q-006', text: 'How many hours of sleep do you usually get per night?', type: 'single_numeric' },
    { id: 'Q-014', text: 'Have you unintentionally lost more than 5 kg recently?', type: 'yes_no', options: ['Yes', 'No'] },
    { id: 'Q-017', text: 'Do you have a family history of any of these cancers?', type: 'multi_select', options: ['Breast', 'Colon', 'Prostate', 'None'] }
  ];

  // --- 3. RENDERING ENGINE ---
  document.addEventListener('DOMContentLoaded', () => {
    renderForm();
    prefillFromAppSheet();
  });

  function renderForm() {
    const container = document.getElementById('form-content');
    container.innerHTML = '';

    QUESTIONS.forEach(q => {
      // Create Wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'question-group';
      wrapper.id = `wrap-${q.id}`;
      wrapper.setAttribute('data-id', q.id);

      // Label
      const label = document.createElement('label');
      label.className = 'q-label';
      label.textContent = q.text;
      wrapper.appendChild(label);

      // Input Logic
      if (q.type === 'text' || q.type === 'email') {
        wrapper.innerHTML += `<input type="${q.type}" name="${q.id}" placeholder="Type here..." required>`;
      } 
      else if (q.type === 'single_numeric') {
        wrapper.innerHTML += `<input type="number" name="${q.id}" placeholder="0" oninput="checkLogic()">`;
      }
      else if (q.options) {
        const grid = document.createElement('div');
        grid.className = 'options-grid';
        
        const inputType = q.type === 'multi_select' ? 'checkbox' : 'radio';
        
        q.options.forEach(opt => {
          const optId = `${q.id}-${opt.replace(/\s+/g, '')}`;
          grid.innerHTML += `
            <label class="option-card" for="${optId}">
              <input type="${inputType}" id="${optId}" name="${q.id}" value="${opt}" onchange="checkLogic()">
              ${opt}
            </label>
          `;
        });
        wrapper.appendChild(grid);
      }

      container.appendChild(wrapper);
    });

    checkLogic(); // Initial check to hide conditional fields
  }

  // --- 4. LOGIC ENGINE (Branching) ---
  function checkLogic() {
    QUESTIONS.forEach(q => {
      if (q.condition) {
        const wrapper = document.getElementById(`wrap-${q.id}`);
        const parentInput = document.querySelector(`input[name="${q.condition.if}"]:checked`);
        
        if (parentInput && parentInput.value === q.condition.equals) {
          wrapper.style.display = 'block';
        } else {
          wrapper.style.display = 'none';
          // Clear hidden values
          const hiddenInputs = wrapper.querySelectorAll('input');
          hiddenInputs.forEach(input => {
            if (input.type === 'text' || input.type === 'number') input.value = '';
            if (input.type === 'radio' || input.type === 'checkbox') input.checked = false;
          });
        }
      }
    });
  }

  // --- 5. DATA TRANSMISSION ---
  document.getElementById('clinical-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.querySelector('.submit-btn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = 'Connecting to Digital Twin...';
    btn.disabled = true;

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Handle Multi-Selects (combine into string)
    QUESTIONS.filter(q => q.type === 'multi_select').forEach(q => {
      const checked = Array.from(document.querySelectorAll(`input[name="${q.id}"]:checked`)).map(cb => cb.value);
      data[q.id] = checked.join('; ');
    });

    try {
      await fetch(ENDPOINT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(data)
      });

      // Simulation delay for UX
      setTimeout(() => {
        document.getElementById('clinical-form').style.display = 'none';
        document.getElementById('success-view').style.display = 'block';
      }, 1500);

    } catch (err) {
      alert('Connection Error. Please check internet.');
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  });

  // --- 6. APPSHEET INTEGRATION ---
  function prefillFromAppSheet() {
    const params = new URLSearchParams(window.location.search);
    const email = params.get('email');
    const name = params.get('name');

    if (email) {
      const emailField = document.querySelector('input[name="email"]');
      if (emailField) {
        emailField.value = email;
        emailField.readOnly = true;
        emailField.style.background = '#f0f0f0';
      }
    }
    if (name) {
      const nameField = document.querySelector('input[name="name"]');
      if (nameField) nameField.value = name;
    }
  }

</script>
</body>
</html>
